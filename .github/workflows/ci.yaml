name: CI
on:
  pull_request:
    branches:
      - main
  push:
    branches:
      - main
  workflow_dispatch:  # manual trigger

jobs:
  coverage:
    runs-on: ${{ matrix.os }}
    timeout-minutes: 10
    strategy:
      max-parallel: 8
      fail-fast: false
      matrix:
        os: [ ubuntu-latest ]
        python-version: [ '3.10' ]

    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ matrix.python-version }}

      - name: Install Poetry
        uses: snok/install-poetry@v1

      - name: Install packages
        run: |
          poetry run make config-poetry
          poetry run make install

      - name: Show installed packages
        run: |
          poetry run poetry show
          poetry run poetry show --tree

      - name: Run unit tests
        run: |
          poetry run make unit-test-cov

      - name: Run integration tests
        run: |
          poetry run make integration-test-cov

      - name: Upload coverage to Codecov
        if: github.repository == 'durandtibo/gravitorch' && (github.event_name == 'push' || github.event_name == 'pull_request')
        uses: codecov/codecov-action@v3
        with:
          files: ./coverage.xml
          # Ignore codecov failures as the codecov server is not
          # very reliable but we don't want to report a failure
          # in the github UI just because the coverage report failed to
          # be published.
          fail_ci_if_error: false

      - name: Test & publish code coverage
        uses: paambaati/codeclimate-action@v5.0.0
        env:
          CC_TEST_REPORTER_ID: ${{secrets.CC_TEST_REPORTER_ID}}
        with:
          coverageLocations: ./coverage.xml:coverage.py
          debug: true


  doctest:
    runs-on: ${{ matrix.os }}
    timeout-minutes: 10
    strategy:
      max-parallel: 8
      fail-fast: false
      matrix:
        os: [ ubuntu-latest ]
        python-version: [ '3.10' ]

    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ matrix.python-version }}

      - name: Install Poetry
        uses: snok/install-poetry@v1

      - name: Install packages
        run: |
          poetry run make config-poetry
          poetry run make install

      - name: Show installed packages
        run: |
          poetry run poetry show
          poetry run poetry show --tree

      - name: Run doctest
        run: |
          poetry run make doctest-src


  format:
    runs-on: ${{ matrix.os }}
    timeout-minutes: 10
    strategy:
      max-parallel: 8
      fail-fast: false
      matrix:
        os: [ ubuntu-latest ]
        python-version: [ '3.10' ]

    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ matrix.python-version }}

      - name: Install Poetry
        uses: snok/install-poetry@v1

      - name: Install packages
        run: |
          poetry run make config-poetry
          poetry run make install

      - name: Show installed packages
        run: |
          poetry run poetry show
          poetry run poetry show --tree

      - name: Format
        run: |
          poetry run make format

      - name: Lint
        run: |
          poetry run make lint


  test:
    runs-on: ${{ matrix.os }}
    timeout-minutes: 10
    strategy:
      max-parallel: 8
      fail-fast: false
      matrix:
        os: [ ubuntu-latest, macos-latest ]
        python-version: [ '3.9', '3.10', '3.11' ]

    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ matrix.python-version }}

      - name: Install Poetry
        uses: snok/install-poetry@v1

      - name: Install packages
        run: |
          poetry run make config-poetry
          poetry run make install

      - name: Show installed packages
        run: |
          poetry run poetry show
          poetry run poetry show --tree

      - name: Run unit tests
        run: |
          poetry run make unit-test-cov

      - name: Run integration tests
        run: |
          poetry run make integration-test-cov

      - name: Run functional tests
        continue-on-error: true
        timeout-minutes: 4
        run: |
          poetry run make functional-test-cov


  test-minimal:
    runs-on: ${{ matrix.os }}
    timeout-minutes: 5
    strategy:
      max-parallel: 8
      fail-fast: false
      matrix:
        os: [ ubuntu-latest, macos-latest ]
        python-version: [ '3.9', '3.10', '3.11' ]

    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ matrix.python-version }}

      - name: Install Poetry
        uses: snok/install-poetry@v1

      - name: Install packages
        run: |
          poetry run make config-poetry
          poetry run make install-min

      - name: Show installed packages
        run: |
          poetry run poetry show
          poetry run poetry show --tree

      - name: Run unit tests
        run: |
          poetry run make unit-test

      - name: Run integration tests
        run: |
          poetry run make integration-test


  test-coola:
    runs-on: ${{ matrix.os }}
    timeout-minutes: 10
    strategy:
      max-parallel: 8
      fail-fast: false
      matrix:
        os: [ ubuntu-latest ]
        python-version: [ '3.10' ]
        coola-version: [ 0.0.20, 0.0.21, 0.0.22 ]

    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ matrix.python-version }}

      - name: Install Poetry
        uses: snok/install-poetry@v1

      - name: Install packages
        run: |
          poetry run make config-poetry
          poetry run make install

      - name: Install PyTorch
        run: |
          poetry run pip install coola==${{ matrix.coola-version }}

      - name: Show installed packages
        run: |
          poetry run poetry show
          poetry run poetry show --tree

      - name: Run unit tests
        run: |
          poetry run make unit-test-cov

      - name: Run integration tests
        run: |
          poetry run make integration-test-cov


  test-hya:
    runs-on: ${{ matrix.os }}
    timeout-minutes: 10
    strategy:
      max-parallel: 8
      fail-fast: false
      matrix:
        os: [ ubuntu-latest ]
        python-version: [ '3.10' ]
        hya-version: [ 0.0.12 ]

    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ matrix.python-version }}

      - name: Install Poetry
        uses: snok/install-poetry@v1

      - name: Install packages
        run: |
          poetry run make config-poetry
          poetry run make install

      - name: Install PyTorch
        run: |
          poetry run pip install hya==${{ matrix.hya-version }}

      - name: Show installed packages
        run: |
          poetry run poetry show
          poetry run poetry show --tree

      - name: Run unit tests
        run: |
          poetry run make unit-test-cov

      - name: Run integration tests
        run: |
          poetry run make integration-test-cov


  test-hydra-core:
    runs-on: ${{ matrix.os }}
    timeout-minutes: 10
    strategy:
      max-parallel: 8
      fail-fast: false
      matrix:
        os: [ ubuntu-latest ]
        python-version: [ '3.10' ]
        hydra-core-version: [ 1.3.2, 1.3.0 ]

    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ matrix.python-version }}

      - name: Install Poetry
        uses: snok/install-poetry@v1

      - name: Install packages
        run: |
          poetry run make config-poetry
          poetry run make install

      - name: Install PyTorch
        run: |
          poetry run pip install hydra-core==${{ matrix.hydra-core-version }}

      - name: Show installed packages
        run: |
          poetry run poetry show
          poetry run poetry show --tree

      - name: Run unit tests
        run: |
          poetry run make unit-test-cov

      - name: Run integration tests
        run: |
          poetry run make integration-test-cov


  test-numpy:
    runs-on: ${{ matrix.os }}
    timeout-minutes: 10
    strategy:
      max-parallel: 8
      fail-fast: false
      matrix:
        os: [ ubuntu-latest ]
        python-version: [ '3.10' ]
        numpy-version: [ 1.25.2, 1.24.3, 1.23.5, 1.22.4 ]

    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ matrix.python-version }}

      - name: Install Poetry
        uses: snok/install-poetry@v1

      - name: Install packages
        run: |
          poetry run make config-poetry
          poetry run make install

      - name: Install PyTorch
        run: |
          poetry run pip install numpy==${{ matrix.numpy-version }}

      - name: Show installed packages
        run: |
          poetry run poetry show
          poetry run poetry show --tree

      - name: Run unit tests
        run: |
          poetry run make unit-test-cov

      - name: Run integration tests
        run: |
          poetry run make integration-test-cov


  test-pytorch-ignite:
    runs-on: ${{ matrix.os }}
    timeout-minutes: 10
    strategy:
      max-parallel: 8
      fail-fast: false
      matrix:
        os: [ ubuntu-latest ]
        python-version: [ '3.10' ]
        pytorch-ignite-version: [ 0.4.12, 0.4.11 ]

    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ matrix.python-version }}

      - name: Install Poetry
        uses: snok/install-poetry@v1

      - name: Install packages
        run: |
          poetry run make config-poetry
          poetry run make install

      - name: Install PyTorch
        run: |
          poetry run pip install pytorch-ignite==${{ matrix.pytorch-ignite-version }}

      - name: Show installed packages
        run: |
          poetry run poetry show
          poetry run poetry show --tree

      - name: Run unit tests
        run: |
          poetry run make unit-test-cov

      - name: Run integration tests
        run: |
          poetry run make integration-test-cov


  test-torch:
    runs-on: ${{ matrix.os }}
    timeout-minutes: 10
    strategy:
      max-parallel: 8
      fail-fast: false
      matrix:
        os: [ ubuntu-latest ]
        python-version: [ '3.10' ]
        pytorch-version: [ 2.0.1, 2.0.0 ]

    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ matrix.python-version }}

      - name: Install Poetry
        uses: snok/install-poetry@v1

      - name: Install packages
        run: |
          poetry run make config-poetry
          poetry run make install

      - name: Install PyTorch
        run: |
          poetry run pip install torch==${{ matrix.pytorch-version }}

      - name: Show installed packages
        run: |
          poetry run poetry show
          poetry run poetry show --tree

      - name: Run unit tests
        run: |
          poetry run make unit-test-cov

      - name: Run integration tests
        run: |
          poetry run make integration-test-cov


  test-tqdm:
    runs-on: ${{ matrix.os }}
    timeout-minutes: 10
    strategy:
      max-parallel: 8
      fail-fast: false
      matrix:
        os: [ ubuntu-latest ]
        python-version: [ '3.10' ]
        pytqdm-version: [ 4.66.1, 4.65.2, 4.64.1, 4.63.2, 4.62.3 ]

    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ matrix.python-version }}

      - name: Install Poetry
        uses: snok/install-poetry@v1

      - name: Install packages
        run: |
          poetry run make config-poetry
          poetry run make install

      - name: Install PyTorch
        run: |
          poetry run pip install tqdm==${{ matrix.pytqdm-version }}

      - name: Show installed packages
        run: |
          poetry run poetry show
          poetry run poetry show --tree

      - name: Run unit tests
        run: |
          poetry run make unit-test-cov

      - name: Run integration tests
        run: |
          poetry run make integration-test-cov


  detect-cyclic-import:
    runs-on: ${{ matrix.os }}
    timeout-minutes: 10
    strategy:
      max-parallel: 8
      fail-fast: false
      matrix:
        os: [ ubuntu-latest ]
        python-version: [ '3.10' ]

    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ matrix.python-version }}

      - name: Install Poetry
        uses: snok/install-poetry@v1

      - name: Install packages
        run: |
          poetry run make config-poetry
          poetry run make install

      - name: Show installed packages
        run: |
          poetry run poetry show
          poetry run poetry show --tree

      - name: check gravitorch.cli
        run: |
          poetry run python -c "from gravitorch import cli"
      - name: check gravitorch.creators
        run: |
          poetry run python -c "from gravitorch import creators"
      - name: check gravitorch.creators.core
        run: |
          poetry run python -c "from gravitorch.creators import core"
      - name: check gravitorch.creators.dataloader
        run: |
          poetry run python -c "from gravitorch.creators import dataloader"
      - name: check gravitorch.creators.datapipe
        run: |
          poetry run python -c "from gravitorch.creators import datapipe"
      - name: check gravitorch.creators.datasource
        run: |
          poetry run python -c "from gravitorch.creators import datasource"
      - name: check gravitorch.creators.lr_scheduler
        run: |
          poetry run python -c "from gravitorch.creators import lr_scheduler"
      - name: check gravitorch.creators.model
        run: |
          poetry run python -c "from gravitorch.creators import model"
      - name: check gravitorch.creators.optimizer
        run: |
          poetry run python -c "from gravitorch.creators import optimizer"
      - name: check gravitorch.data
        run: |
          poetry run python -c "from gravitorch import data"
      - name: check gravitorch.data.datacreators
        run: |
          poetry run python -c "from gravitorch.data import datacreators"
      - name: check gravitorch.data.dataloaders
        run: |
          poetry run python -c "from gravitorch.data import dataloaders"
      - name: check gravitorch.data.datasets
        run: |
          poetry run python -c "from gravitorch.data import datasets"
      - name: check gravitorch.data.partitioners
        run: |
          poetry run python -c "from gravitorch.data import partitioners"
      - name: check gravitorch.datapipes
        run: |
          poetry run python -c "from gravitorch import datapipes"
      - name: check gravitorch.datapipes.iter
        run: |
          poetry run python -c "from gravitorch.datapipes import iter"
      - name: check gravitorch.datapipes.map
        run: |
          poetry run python -c "from gravitorch.datapipes import map"
      - name: check gravitorch.datasources
        run: |
          poetry run python -c "from gravitorch import datasources"
      - name: check gravitorch.distributed
        run: |
          poetry run python -c "from gravitorch import distributed"
      - name: check gravitorch.engines
        run: |
          poetry run python -c "from gravitorch import engines"
      - name: check gravitorch.handlers
        run: |
          poetry run python -c "from gravitorch import handlers"
      - name: check gravitorch.loops
        run: |
          poetry run python -c "from gravitorch import loops"
      - name: check gravitorch.loops.evaluation
        run: |
          poetry run python -c "from gravitorch.loops import evaluation"
      - name: check gravitorch.loops.observers
        run: |
          poetry run python -c "from gravitorch.loops import observers"
      - name: check gravitorch.loops.training
        run: |
          poetry run python -c "from gravitorch.loops import training"
      - name: check gravitorch.lr_schedulers
        run: |
          poetry run python -c "from gravitorch import lr_schedulers"
      - name: check gravitorch.models
        run: |
          poetry run python -c "from gravitorch import models"
      - name: check gravitorch.models.criteria
        run: |
          poetry run python -c "from gravitorch.models import criteria"
      - name: check gravitorch.models.metrics
        run: |
          poetry run python -c "from gravitorch.models import metrics"
      - name: check gravitorch.models.networks
        run: |
          poetry run python -c "from gravitorch.models import networks"
      - name: check gravitorch.models.utils
        run: |
          poetry run python -c "from gravitorch.models import utils"
      - name: check gravitorch.nn
        run: |
          poetry run python -c "from gravitorch import nn"
      - name: check gravitorch.nn.functional
        run: |
          poetry run python -c "from gravitorch.nn import functional"
      - name: check gravitorch.nn.init
        run: |
          poetry run python -c "from gravitorch.nn import init"
      - name: check gravitorch.nn.utils
        run: |
          poetry run python -c "from gravitorch.nn import utils"
      - name: check gravitorch.optimizers
        run: |
          poetry run python -c "from gravitorch import optimizers"
      - name: check gravitorch.rsrc
        run: |
          poetry run python -c "from gravitorch import rsrc"
      - name: check gravitorch.runners
        run: |
          poetry run python -c "from gravitorch import runners"
      - name: check gravitorch.testing
        run: |
          poetry run python -c "from gravitorch import testing"

      - name: check gravitorch.utils
        run: |
          poetry run python -c "from gravitorch import utils"
      - name: check gravitorch.utils.artifacts
        run: |
          poetry run python -c "from gravitorch.utils import artifacts"
      - name: check gravitorch.utils.device_placement
        run: |
          poetry run python -c "from gravitorch.utils import device_placement"
      - name: check gravitorch.utils.engine_states
        run: |
          poetry run python -c "from gravitorch.utils import engine_states"
      - name: check gravitorch.utils.exp_trackers
        run: |
          poetry run python -c "from gravitorch.utils import exp_trackers"
      - name: check gravitorch.utils.history
        run: |
          poetry run python -c "from gravitorch.utils import exp_trackers"
      - name: check gravitorch.utils.meters
        run: |
          poetry run python -c "from gravitorch.utils import meters"
      - name: check gravitorch.utils.profilers
        run: |
          poetry run python -c "from gravitorch.utils import profilers"
      - name: check gravitorch.utils.tensor
        run: |
          poetry run python -c "from gravitorch.utils import tensor"
